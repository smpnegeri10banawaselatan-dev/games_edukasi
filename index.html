<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UTS Informatika - Game & Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .drop-zone { border: 3px dashed #cbd5e1; min-height:120px; border-radius:12px; padding:16px; }
  .drop-zone.drag-over { background:#eef2ff; border-color:#6366f1; }
  .drop-zone.correct { background:#dcfCE7; border-color:#10b981; }
  .drop-zone.incorrect { background:#fee2e2; border-color:#ef4444; }
</style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">

<div class="max-w-5xl mx-auto">

  <!-- Header with school logo placeholder -->
  <header class="flex items-center gap-4 mb-6">
    <img id="school-logo" src="smpn10.jpg" alt="Logo Sekolah" style="width:72px;height:72px;border-radius:8px;display:none;">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">SMPN 10 BANAWA SELATAN</h1>
      <p class="text-sm text-gray-600">UTS Informatika - Interaktif</p>
    </div>
  </header>

  <!-- Login -->
  <div id="login-card" class="bg-white rounded-xl shadow p-6 mb-6 max-w-2xl">
    <h2 class="text-xl font-semibold mb-4">Login</h2>
    <div class="grid grid-cols-2 gap-4">
      <input id="input-username" type="text" placeholder="Username" class="border p-2 rounded" />
      <input id="input-password" type="password" placeholder="Password" class="border p-2 rounded" />
    </div>
    <div class="mt-4 flex gap-2">
      <button id="btn-login" class="bg-blue-600 text-white px-4 py-2 rounded">Login</button>
      <button id="btn-demo-student" class="bg-green-500 text-white px-4 py-2 rounded">Masuk sebagai Siswa </button>
    </div>
    <p id="login-error" class="text-red-600 mt-3"></p>
  </div>

  <!-- Game & Dashboard container (hidden until login) -->
  <div id="app" class="hidden">

    <!-- Student info & controls -->
    <div class="bg-white rounded-xl shadow p-6 mb-6 flex items-center justify-between">
      <div>
        <div>Selamat datang, <strong id="display-username"></strong> (<span id="display-role"></span>)</div>
        <div class="text-sm text-gray-500">Kategori: 
          <select id="category-select" class="border rounded p-1 ml-2">
            <option value="hardware">Hardware</option>
            <option value="software">Software</option>
            <option value="network">Network</option>
            <option value="algorithm">Algoritma</option>
          </select>
        </div>
      </div>
      <div class="text-right">
        <div class="text-lg font-bold text-green-600" id="score">0</div>
        <div class="text-sm text-gray-600">Skor</div>
      </div>
    </div>

    <div class="grid lg:grid-cols-12 gap-6">

      <!-- Left - Items -->
      <div class="lg:col-span-4">
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="font-semibold mb-4" id="items-title">🔧 Komponen</h3>
          <div id="drag-items" class="grid grid-cols-2 gap-3"></div>
        </div>
      </div>

      <!-- Right - Zones & Timer -->
      <div class="lg:col-span-8">
        <div class="bg-white rounded-xl shadow p-6 mb-4">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold">🎯 Drop Zones</h3>
            <div class="text-sm">Waktu: <span id="timer">00:00</span></div>
          </div>
          <div id="drop-zones" class="grid md:grid-cols-2 gap-4"></div>
        </div>

        <div class="bg-white rounded-xl shadow p-4">
          <div class="flex justify-between items-center">
            <div>
              <button id="btn-reset" class="bg-red-500 text-white px-4 py-2 rounded">Reset</button>
            </div>
            <div>
              <button id="btn-logout" class="bg-gray-300 px-4 py-2 rounded">Logout</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Guru Dashboard (visible only to guru) -->
    <div id="guru-dashboard" class="hidden mt-6 bg-white rounded-xl shadow p-6">
      <h3 class="font-semibold mb-3">📊 Dashboard Guru - Rekap Hasil</h3>
      <div class="mb-4 flex gap-2">
        <input id="filter-username" placeholder="Filter username" class="border p-2 rounded">
        <input id="filter-kategori" placeholder="Filter kategori" class="border p-2 rounded">
        <button id="btn-filter" class="bg-blue-600 text-white px-3 py-2 rounded">Filter</button>
        <button id="btn-refresh" class="bg-green-500 text-white px-3 py-2 rounded">Refresh</button>
      </div>
      <div style="overflow:auto; max-height:300px;">
        <table class="min-w-full text-sm" id="table-scores">
          <thead class="bg-gray-100 sticky top-0">
            <tr><th class="p-2">#</th><th class="p-2">Timestamp</th><th class="p-2">Username</th><th class="p-2">Role</th><th class="p-2">Kategori</th><th class="p-2">Score</th><th class="p-2">Duration</th></tr>
          </thead>
          <tbody id="scores-body"></tbody>
        </table>
      </div>
    </div>

  </div>

</div>

<script>
// ---------- CONFIG ----------
// Ganti URL_APPS_SCRIPT dengan URL Web App kamu setelah deploy
const URL_APPS_SCRIPT = 'https://script.google.com/macros/s/AKfycbzXhe9PKU6IMFIdZaPic-_hegMd0p3Q2JQdvDzRJS3TXl6HuqDdLRP5L_hk9cdJNHei/exec';
// ----------------------------

let currentUser = null;
let currentRole = null;
let currentCategory = 'hardware';
let score = 0;
let correctAnswers = 0;
let totalQuestions = 0;
let usedItems = new Set();
let timerInterval = null;
let startTime = null;

// Demo materials (same as earlier)
const materials = {
  hardware: {
    title: '🔧 Komponen Hardware',
    items: [
      { id: 'cpu', name: 'CPU', icon: '🧠', target: 'processor' },
      { id: 'ram', name: 'RAM', icon: '💾', target: 'memory' },
      { id: 'hdd', name: 'Hard Disk', icon: '💿', target: 'storage' },
      { id: 'ssd', name: 'SSD', icon: '⚡', target: 'storage' }
    ],
    zones: [
      { id: 'processor', name: 'Processor', description: 'Otak komputer' },
      { id: 'memory', name: 'Memori', description: 'Penyimpanan sementara' },
      { id: 'storage', name: 'Penyimpanan', description: 'Penyimpanan permanen' },
      { id: 'graphics', name: 'Grafis', description: 'Pemroses tampilan' }
    ]
  },
  software: {
    title: '💿 Jenis Software',
    items: [
      { id: 'windows', name: 'Windows', icon: '🪟', target: 'os' },
      { id: 'word', name: 'MS Word', icon: '📝', target: 'office' },
      { id: 'excel', name: 'MS Excel', icon: '📊', target: 'office' }
    ],
    zones: [
      { id: 'os', name: 'Sistem Operasi', description: 'Mengelola komputer' },
      { id: 'office', name: 'Aplikasi Perkantoran', description: 'Untuk bekerja' },
      { id: 'graphics', name: 'Aplikasi Grafis', description: 'Edit gambar/video' }
    ]
  },
  network: {
    title: '🌐 Komponen Jaringan',
    items: [
      { id: 'router', name: 'Router', icon: '📡', target: 'routing' },
      { id: 'switch', name: 'Switch', icon: '🔀', target: 'switching' },
      { id: 'cable', name: 'Kabel', icon: '🔌', target: 'transmission' }
    ],
    zones: [
      { id: 'routing', name: 'Routing', description: 'Mengarahkan data' },
      { id: 'switching', name: 'Switching', description: 'Menghubungkan perangkat' },
      { id: 'transmission', name: 'Transmisi', description: 'Media pengiriman' }
    ]
  },
  algorithm: {
    title: '🧮 Konsep Algoritma',
    items: [
      { id: 'input', name: 'Input', icon: '📥', target: 'data-input' },
      { id: 'process', name: 'Proses', icon: '⚙️', target: 'processing' }
    ],
    zones: [
      { id: 'data-input', name: 'Input Data', description: 'Masukkan data' },
      { id: 'processing', name: 'Pemrosesan', description: 'Mengolah data' }
    ]
  }
};

// ------------- UI helpers -------------
function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }

// ------------- Login logic -------------
document.getElementById('btn-login').addEventListener('click', async () => {
  const username = document.getElementById('input-username').value.trim();
  const password = document.getElementById('input-password').value.trim();
  if(!username || !password){ document.getElementById('login-error').innerText = 'Isi username & password'; return; }
  try {
    const res = await fetch(URL_APPS_SCRIPT, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ action: 'login', username, password })
    });
    const j = await res.json();
    if(j.success){
      currentUser = j.username;
      currentRole = j.role;
      afterLogin();
    } else {
      document.getElementById('login-error').innerText = j.message || 'Login gagal';
    }
  } catch (err) {
    console.error(err);
    document.getElementById('login-error').innerText = 'Gagal terhubung ke server';
  }
});

// demo quick student
document.getElementById('btn-demo-student').addEventListener('click', () => {
  currentUser = 'siswa_demo';
  currentRole = 'siswa';
  afterLogin();
});

function afterLogin(){
  hide(document.getElementById('login-card'));
  show(document.getElementById('app'));
  document.getElementById('display-username').innerText = currentUser;
  document.getElementById('display-role').innerText = currentRole;
  if(currentRole === 'guru') show(document.getElementById('guru-dashboard'));
  initGame();
  startTimer();
  loadLeaderboard();
}

document.getElementById('btn-logout').addEventListener('click', () => {
  location.reload();
});

// ------------- Game logic -------------
document.getElementById('category-select').addEventListener('change', (e) => {
  currentCategory = e.target.value;
  resetGameState();
  loadCategory(currentCategory);
});

function initGame(){
  loadCategory(currentCategory);
}

function loadCategory(category){
  const material = materials[category];
  totalQuestions = material.items.length;
  document.getElementById('items-title').innerText = material.title;
  loadDragItems(material.items);
  loadDropZones(material.zones);
  updateScoreUI();
}

function loadDragItems(items){
  const container = document.getElementById('drag-items');
  container.innerHTML = '';
  items.forEach(item => {
    const d = document.createElement('div');
    d.className = 'drag-item bg-white p-3 rounded cursor-grab text-center border';
    d.draggable = true;
    d.dataset.itemId = item.id;
    d.dataset.target = item.target;
    d.innerHTML = `<div style="font-size:28px">${item.icon}</div><div class="mt-1">${item.name}</div>`;
    d.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', JSON.stringify({ itemId: item.id, target: item.target, name: item.name }));
      d.classList.add('opacity-50');
    });
    d.addEventListener('dragend', () => d.classList.remove('opacity-50'));
    container.appendChild(d);
  });
}

function loadDropZones(zones){
  const container = document.getElementById('drop-zones');
  container.innerHTML = '';
  zones.forEach(z => {
    const div = document.createElement('div');
    div.className = 'drop-zone bg-gray-50 p-4 rounded';
    div.dataset.zoneId = z.id;
    div.innerHTML = `<h4 class="font-semibold">${z.name}</h4><p class="text-sm text-gray-600">${z.description}</p><div class="mt-3 text-3xl text-gray-300">📋</div>`;
    div.addEventListener('dragover', e => e.preventDefault());
    div.addEventListener('dragenter', e => div.classList.add('drag-over'));
    div.addEventListener('dragleave', e => div.classList.remove('drag-over'));
    div.addEventListener('drop', e => {
      e.preventDefault(); div.classList.remove('drag-over');
      const data = JSON.parse(e.dataTransfer.getData('text/plain'));
      handleDrop(div, data);
    });
    container.appendChild(div);
  });
}

function handleDrop(zoneEl, data){
  if(usedItems.has(data.itemId)) return;
  const zoneId = zoneEl.dataset.zoneId;
  if(data.target === zoneId){
    zoneEl.classList.add('correct');
    zoneEl.innerHTML = `<h4 class="font-semibold text-green-700">✅ Benar!</h4><p class="text-sm text-green-600">Jawaban tepat</p><div class="mt-3 text-3xl text-green-500">✅</div>`;
    score += 10;
    correctAnswers++;
    usedItems.add(data.itemId);
    // disable item visual
    const draggedItem = document.querySelector(`[data-item-id="${data.itemId}"]`);
    if(draggedItem){ draggedItem.style.opacity = '0.3'; draggedItem.draggable = false; draggedItem.style.pointerEvents = 'none'; }
    updateScoreUI();
    if(correctAnswers === totalQuestions){
      // game complete
      stopTimer();
      saveResultToServer();
      setTimeout(() => alert('🎉 Selesai! Skor: ' + score), 200);
    }
    setTimeout(()=> zoneEl.classList.remove('correct'), 1600);
  } else {
    zoneEl.classList.add('incorrect');
    setTimeout(()=> zoneEl.classList.remove('incorrect'), 800);
  }
}

function updateScoreUI(){
  document.getElementById('score').innerText = score;
}

// reset game state
function resetGameState(){
  score = 0; correctAnswers = 0; usedItems.clear(); startTime = new Date();
  updateScoreUI();
}

// Reset button
document.getElementById('btn-reset').addEventListener('click', () => {
  resetGameState();
  loadCategory(currentCategory);
  startTimer();
});

// ---------- Timer ----------
function startTimer(){
  if(timerInterval) clearInterval(timerInterval);
  startTime = new Date();
  timerInterval = setInterval(() => {
    const diff = Math.floor((new Date() - startTime)/1000);
    const mm = String(Math.floor(diff/60)).padStart(2,'0');
    const ss = String(diff%60).padStart(2,'0');
    document.getElementById('timer').innerText = mm + ':' + ss;
  }, 500);
}
function stopTimer(){ if(timerInterval) clearInterval(timerInterval); timerInterval = null; }

// ---------- Server communication ----------
async function saveResultToServer(){
  const payload = {
    action: 'saveScore',
    username: currentUser || 'Anonim',
    role: currentRole || '',
    kategori: currentCategory || '',
    score: score,
    duration: document.getElementById('timer').innerText,
    completedAt: new Date().toISOString()
  };
  try {
    await fetch(URL_APPS_SCRIPT, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    // refresh leaderboard after save
    setTimeout(loadLeaderboard, 800);
  } catch (err) {
    console.warn('Gagal mengirim hasil ke server', err);
  }
}

async function loadLeaderboard(){
  try {
    const fuser = document.getElementById('filter-username').value.trim();
    const fk = document.getElementById('filter-kategori').value.trim();
    let q = URL_APPS_SCRIPT + '?action=leaderboard';
    if(fk) q += '&kategori=' + encodeURIComponent(fk);
    if(fuser) q += '&username=' + encodeURIComponent(fuser);
    const res = await fetch(q);
    const data = await res.json();
    const tbody = document.getElementById('scores-body');
    tbody.innerHTML = '';
    data.forEach((r,i) => {
      tbody.innerHTML += `<tr class="${i%2==0?'bg-gray-50':''}"><td class="p-2">${i+1}</td><td class="p-2">${new Date(r.timestamp).toLocaleString()}</td><td class="p-2">${r.username}</td><td class="p-2">${r.role}</td><td class="p-2">${r.kategori}</td><td class="p-2">${r.score}</td><td class="p-2">${r.duration}</td></tr>`;
    });
  } catch (err) {
    console.warn('Gagal memuat leaderboard', err);
  }
}

document.getElementById('btn-filter').addEventListener('click', loadLeaderboard);
document.getElementById('btn-refresh').addEventListener('click', loadLeaderboard);

// initial
resetGameState();
</script>
</body>
</html>
